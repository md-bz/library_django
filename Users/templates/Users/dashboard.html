{% extends 'base.html' %}

{% block content %}
<h2>Dashboard</h2>

<p>Welcome, <strong>{{ username }}</strong> (role: {{ role }})</p>

{% if user.notifications %}
<ul>
    {% for note in user.notifications %}
    <li>{{ note }}</li>
    {% endfor %}
</ul>
<form action="{% url 'clear_notifications' user.id %}" method="post">
    {% csrf_token %}
    <button type="submit">Clear notifications</button>
</form>
{% endif %}

<form action="{% url 'update_me' %}" method="post">
    {% csrf_token %}
    <label >Username:

        <input type="text" name="username" value="{{ user.username }}">
    </label>

    <label>Password:
        <input type="password" name="password">
    </label> 
    <button type="submit">Update</button>
</form>

<hr>
<h3>My Borrowing History</h3>
{% if borrowings %}
<ul>
    {% for item in borrowings %}
    <li>
        <strong>{{ item.book.title }}</strong> by {{ item.book.author }}<br>
        <small>
            Status: <span style="color: {% if item.status == 'Approved' %}green{% elif item.status == 'Rejected' %}red{% elif item.status == 'Waiting Approval' %}orange{% else %}blue{% endif %};">{{ item.status }}</span><br>
            Requested for: {{ item.borrowing.borrowed_for }} days<br>
            {% if item.borrowing.borrowed_till %}
            Due date: {{ item.borrowing.borrowed_till|date:"Y-m-d H:i" }}<br>
            {% endif %}
            {% if item.borrowing.returned_at %}
            Returned: {{ item.borrowing.returned_at|date:"Y-m-d H:i" }}
            {% endif %}
        </small>
    </li>
    {% endfor %}
</ul>
{% else %}
<p>No borrowing history yet.</p>
{% endif %}


{% if role == 'admin' %}
<hr>
    <h3>Users</h3>
<ul>
    {% for u in users %}
    <li>
        {{ u.username }} ({{ u.role }})
        <a href="{% url 'user_update' u.id %}">Update</a>
        <a href="{% url 'send_notification' u.id %}">send notifications</a>
        <form action="{% url 'user_delete' u.id %}" method="post" style="display:inline">
            {% csrf_token %}
            <button type="submit">Delete</button>
        </form>
    </li>
    {% empty %}
    <li>No users yet.</li>
    {% endfor %}
    </ul>
{% endif %}

{% endblock %}
